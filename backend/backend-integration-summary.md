# CosmiFi Backend Integration Summary

## Overview

This document provides a comprehensive summary of the Supabase Edge Functions integration plan for the CosmiFi backend. The plan is designed to support the Stage A requirements outlined in the project documentation, enabling engineers to upload mechanical/CAD designs, auto-generate metadata, pin files to IPFS, and mint provable ownership NFTs on Base.

## Architecture Summary

The backend architecture follows a serverless approach using Supabase Edge Functions with the following key components:

1. **Authentication Layer**: JWT-based authentication using Ethereum wallet signatures
2. **Storage Layer**: IPFS integration via Pinata for decentralized file storage
3. **Database Layer**: Supabase PostgreSQL for indexing and event synchronization
4. **API Layer**: Edge Functions providing RESTful endpoints for all operations

## Key Features Implemented

### 1. User Authentication & Profile Management
- Wallet signature verification for secure authentication
- JWT token generation and validation
- User profile creation and management
- Social links integration

### 2. File Upload & IPFS Integration
- CAD file upload (ZIP format, max 50MB)
- Preview image upload (PNG/JPG/WebP, max 50MB)
- Automatic pinning to IPFS via Pinata
- CID generation and storage

### 3. Design Management
- Draft creation and management
- Metadata generation following NFT standards
- Design status tracking (draft → uploaded → metadata_ready → minted)
- Category and tag-based organization

### 4. NFT Minting Support
- Metadata generation in standard NFT format
- Preparation of designs for minting
- Webhook integration for blockchain event synchronization
- Token ID tracking and management

## Database Schema

### Profiles Table
```sql
CREATE TABLE profiles (
  wallet_address TEXT PRIMARY KEY,
  username TEXT,
  bio TEXT,
  avatar_url TEXT,
  social_links JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Designs Table
```sql
CREATE TABLE designs (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  token_id BIGINT UNIQUE,
  owner_address TEXT NOT NULL,
  metadata_cid TEXT,
  name TEXT,
  description TEXT,
  category TEXT,
  tags TEXT[] DEFAULT '{}',
  version TEXT DEFAULT 'v1.0',
  license TEXT DEFAULT 'CC-BY-4.0',
  preview_cid TEXT,
  cad_zip_cid TEXT,
  status TEXT DEFAULT 'draft' CHECK (status IN ('draft', 'uploaded', 'metadata_ready', 'minted')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  minted_at TIMESTAMP WITH TIME ZONE
);
```

## API Endpoints

### Authentication
- `POST /auth/verify-wallet` - Verify wallet signature and generate JWT

### Profile Management
- `POST /profiles/create-profile` - Create new user profile
- `GET /profiles/get-profile` - Retrieve user profile
- `PUT /profiles/update-profile` - Update user profile

### Design Management
- `POST /designs/upload-files` - Upload CAD files and preview images
- `POST /designs/create-draft` - Create design draft
- `POST /designs/generate-metadata` - Generate NFT metadata
- `POST /designs/prepare-mint` - Prepare design for minting
- `GET /designs/get-designs` - Retrieve designs with filtering

### Webhooks
- `POST /webhook/nft-minted` - Handle NFT minting events

## Security Considerations

1. **Authentication**: JWT tokens with 24-hour expiration
2. **Authorization**: Row Level Security (RLS) policies in Supabase
3. **Input Validation**: File type and size validation
4. **Rate Limiting**: API endpoint rate limiting
5. **Secure Headers**: Proper CORS and security headers

## Performance Optimizations

1. **File Compression**: Automatic compression for uploaded files
2. **CDN Integration**: IPFS content delivery optimization
3. **Database Indexing**: Optimized queries for design retrieval
4. **Caching Strategy**: Response caching for frequently accessed data
5. **Connection Pooling**: Efficient database connection management

## Development Workflow

### Local Development
```bash
# Start local Supabase
supabase start

# Deploy functions locally
supabase functions serve --env-file .env

# Run tests
deno test --allow-net
```

### Deployment
```bash
# Deploy all functions
supabase functions deploy

# Set secrets
supabase secrets set PINATA_API_KEY=your_key
supabase secrets set PINATA_SECRET_KEY=your_secret
```

## Testing Strategy

1. **Unit Tests**: Individual function testing
2. **Integration Tests**: Database and IPFS integration testing
3. **E2E Tests**: Complete workflow testing
4. **Load Tests**: Performance testing under load
5. **Security Tests**: Authentication and authorization testing

## Monitoring & Logging

1. **Function Logs**: Supabase function execution logs
2. **Error Tracking**: Comprehensive error reporting
3. **Performance Metrics**: Response time and throughput monitoring
4. **Usage Analytics**: API usage statistics
5. **Health Checks**: System health monitoring

## Environment Variables

```env
# Supabase Configuration
SUPABASE_URL=your_supabase_project_url
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
SUPABASE_ANON_KEY=your_supabase_anon_key

# Pinata Configuration
PINATA_API_KEY=your_pinata_api_key
PINATA_SECRET_KEY=your_pinata_secret_key

# JWT Configuration
JWT_SECRET=your_jwt_secret_key_at_least_32_characters_long

# Blockchain Configuration
RPC_BASE_SEPOLIA=your_base_sepolia_rpc_url
CONTRACT_ADDRESS=your_deployed_contract_address
```

## Implementation Roadmap

### Phase 1: Foundation (Week 1)
- Set up Supabase project and Edge Functions
- Implement authentication system
- Create database schema
- Set up development environment

### Phase 2: Core Features (Week 2)
- Implement file upload functionality
- Create IPFS integration
- Develop design management system
- Implement metadata generation

### Phase 3: Integration (Week 3)
- Create webhook handlers
- Implement frontend integration points
- Set up testing framework
- Create API documentation

### Phase 4: Deployment (Week 4)
- Deploy to production
- Set up monitoring and logging
- Performance optimization
- Security hardening

## Success Metrics

1. **Performance**: API response times under 500ms
2. **Reliability**: 99.9% uptime for critical functions
3. **Security**: Zero security vulnerabilities in production
4. **Scalability**: Support for 1000+ concurrent users
5. **User Experience**: Seamless file upload and minting flow

## Next Steps

1. **Immediate**: Set up Supabase project and initialize backend directory
2. **Short-term**: Implement core Edge Functions and database schema
3. **Medium-term**: Integrate with frontend and test complete workflow
4. **Long-term**: Deploy to production and set up monitoring

## Conclusion

This comprehensive backend integration plan provides a solid foundation for the CosmiFi platform's Stage A requirements. The serverless architecture using Supabase Edge Functions offers scalability, security, and maintainability while supporting the complex workflow of CAD file upload, IPFS storage, and NFT minting.

The modular design allows for easy extension to support future Stage B requirements such as fractional ownership and composable NFTs, ensuring the backend can evolve with the platform's needs.